"use strict";var Chiniisou;!function(Chiniisou){var Suit,TileSize;!function(Suit){Suit[Suit.Characters=0]="Characters",Suit[Suit.Bomboos=1]="Bomboos",Suit[Suit.Dots=2]="Dots"}(Suit||(Suit={})),function(TileSize){TileSize[TileSize.Small=0]="Small",TileSize[TileSize.Medium=1]="Medium",TileSize[TileSize.Large=2]="Large"}(TileSize||(TileSize={}));var Helper=function(){function Helper(){}return Helper.isFromJapan=function(){var language=window.navigator.languages&&window.navigator.languages[0]||window.navigator.language;return null!=language&&"ja"===language.substr(0,2)},Helper.save=function(key,data){return void 0!==window.localStorage&&(window.localStorage.setItem(key,JSON.stringify(data)),!0)},Helper.load=function(key){if(void 0!==window.localStorage){var json=window.localStorage.getItem(key);return null==json?null:JSON.parse(json)}return null},Helper.getRandomNumber=function(minimum,maximum){return Math.floor(Math.random()*(maximum-minimum+1))+minimum},Helper.getRandomIndex=function(number){return Math.floor(Math.random()*number)},Helper.getRandomElement=function(array){return array[Helper.getRandomIndex(array.length)]},Helper.arrayEquals=function(array1,array2){if(array1.length!=array2.length)return!1;for(var index=0;index<array1.length;index++)if(array1[index]!==array2[index])return!1;return!0},Helper.shuffle=function(array){for(var count=array.length;count>1;count--)Helper.shuffleTail(array,count)},Helper.shuffleTail=function(collection,count){var lastIndex=count-1,randomIndex=Helper.getRandomIndex(count);Helper.swap(collection,lastIndex,randomIndex)},Helper.swap=function(collection,index1,index2){if(index1!=index2){var temporary=collection[index1];collection[index1]=collection[index2],collection[index2]=temporary}},Helper}(),Model=function(){function Model(){this.allHands=Model.getAllHands(),this.completeHands=Model.getCompleteHands(this.allHands)}return Model.prototype.getNewReadyToWinHand=function(){var completeHand=Helper.getRandomElement(this.completeHands);return Model.getReadyToWinHand(completeHand)},Model.makeComplateHandIndexes=function(readyToWinHand){for(var handIndexes=[],handIndex=0;handIndex<9;handIndex++){var hand=Model.appendHand(readyToWinHand,handIndex);null!==hand&&Model.isCompleteHand(hand)&&handIndexes.push(handIndex)}return handIndexes},Model.shuffledHandIndexes=function(hand){var handIndexes=Model.handToHandIndexes(hand);return Helper.shuffle(handIndexes),handIndexes},Model.handToHandIndexes=function(hand){for(var handIndexes=[],handIndex=0;handIndex<hand.length;handIndex++)for(var index=0;index<hand[handIndex];index++)handIndexes.push(handIndex);return handIndexes},Model.getAllHands=function(){for(var hands=[],tileNumber1=0;tileNumber1<=4;tileNumber1++)for(var tileNumberSum1=tileNumber1,tileNumber2=0;tileNumber2<=4;tileNumber2++)for(var tileNumberSum2=tileNumberSum1+tileNumber2,tileNumber3=0;tileNumber3<=4;tileNumber3++)for(var tileNumberSum3=tileNumberSum2+tileNumber3,tileNumber4=0;tileNumber4<=4;tileNumber4++){var tileNumberSum4=tileNumberSum3+tileNumber4;if(tileNumberSum4>=Model.completeHandsNumber){tileNumberSum4==Model.completeHandsNumber&&hands.push([tileNumber1,tileNumber2,tileNumber3,tileNumber4,0,0,0,0,0]);break}for(var tileNumber5=0;tileNumber5<=4;tileNumber5++){var tileNumberSum5=tileNumberSum4+tileNumber5;if(tileNumberSum5>=Model.completeHandsNumber){tileNumberSum5==Model.completeHandsNumber&&hands.push([tileNumber1,tileNumber2,tileNumber3,tileNumber4,tileNumber5,0,0,0,0]);break}for(var tileNumber6=0;tileNumber6<=4;tileNumber6++){var tileNumberSum6=tileNumberSum5+tileNumber6;if(tileNumberSum6>=Model.completeHandsNumber){tileNumberSum6==Model.completeHandsNumber&&hands.push([tileNumber1,tileNumber2,tileNumber3,tileNumber4,tileNumber5,tileNumber6,0,0,0]);break}for(var tileNumber7=0;tileNumber7<=4;tileNumber7++){var tileNumberSum7=tileNumberSum6+tileNumber7;if(tileNumberSum7>=Model.completeHandsNumber){tileNumberSum7==Model.completeHandsNumber&&hands.push([tileNumber1,tileNumber2,tileNumber3,tileNumber4,tileNumber5,tileNumber6,tileNumber7,0,0]);break}for(var tileNumber8=0;tileNumber8<=4;tileNumber8++){var tileNumberSum8=tileNumberSum7+tileNumber8;if(tileNumberSum8>=Model.completeHandsNumber){tileNumberSum8==Model.completeHandsNumber&&hands.push([tileNumber1,tileNumber2,tileNumber3,tileNumber4,tileNumber5,tileNumber6,tileNumber7,tileNumber8,0]);break}for(var tileNumber9=0;tileNumber9<=4;tileNumber9++){var tileNumberSum9=tileNumberSum8+tileNumber9;if(tileNumberSum9>=Model.completeHandsNumber){tileNumberSum9==Model.completeHandsNumber&&hands.push([tileNumber1,tileNumber2,tileNumber3,tileNumber4,tileNumber5,tileNumber6,tileNumber7,tileNumber8,tileNumber9]);break}}}}}}}return hands},Model.isSevenPairs=function(hand){for(var index=0;index<hand.length;index++)if(0!=hand[index]&&2!=hand[index])return!1;return!0},Model.maybeCompleteHand=function(hand){for(var a=hand[0],b=hand[1],i=0;i<7;i++){var r=a%3;if(!(b>=r&&hand[i+2]>=r))return!1;a=b-r,b=hand[i+2]-r}return a%3==0&&b%3==0},Model.isCompleteHand=function(hand){if(Model.isSevenPairs(hand))return!0;for(var p=0,i=0;i<9;i++)p+=i*hand[i];for(var i=2*p%3;i<9;i+=3){if(hand[i]-=2,hand[i]>=0&&Model.maybeCompleteHand(hand))return hand[i]+=2,!0;hand[i]+=2}return!1},Model.getCompleteHands=function(allHands){return allHands.filter((function(hand){return Model.isCompleteHand(hand)}))},Model.decrementHand=function(hand){for(var randomIndex=Helper.getRandomIndex(Model.completeHandsNumber),index=0,handIndex=0;handIndex<hand.length;handIndex++)if((index+=hand[handIndex])>randomIndex){var clonedHand=hand.concat();if(0==clonedHand[handIndex])throw new Error("Error: decrementHand failed.");return clonedHand[handIndex]--,[clonedHand,handIndex]}throw new Error("Error: decrementHand failed.")},Model.getReadyToWinHand=function(completeHand){return Model.decrementHand(completeHand)[0]},Model.appendHand=function(hand,handIndex){var clonedHand=hand.concat();return clonedHand[handIndex]<4?(clonedHand[handIndex]++,clonedHand):null},Model.completeHandsNumber=14,Model}(),ViewSettings=function(){function ViewSettings(){this._isJapanese=Helper.isFromJapan(),this._fontOrImage=!0,this._suit=Suit.Characters,this._tileSize=TileSize.Medium,this._isSorted=!0}return Object.defineProperty(ViewSettings.prototype,"isJapanese",{get:function(){return this._isJapanese},set:function(value){value!=this._isJapanese&&(this._isJapanese=value,this.save())},enumerable:!0,configurable:!0}),Object.defineProperty(ViewSettings.prototype,"fontOrImage",{get:function(){return this._fontOrImage},set:function(value){value!=this._fontOrImage&&(this._fontOrImage=value,this.save())},enumerable:!0,configurable:!0}),Object.defineProperty(ViewSettings.prototype,"suit",{get:function(){return this._suit},set:function(value){value!=this._suit&&(this._suit=value,this.save())},enumerable:!0,configurable:!0}),Object.defineProperty(ViewSettings.prototype,"tileSize",{get:function(){return this._tileSize},set:function(value){value!=this._tileSize&&(this._tileSize=value,this.save())},enumerable:!0,configurable:!0}),Object.defineProperty(ViewSettings.prototype,"isSorted",{get:function(){return this._isSorted},set:function(value){value!=this._isSorted&&(this._isSorted=value,this.save())},enumerable:!0,configurable:!0}),ViewSettings.prototype.load=function(){var loadedData=Helper.load(ViewSettings.dataKey);return null!=loadedData&&(this._isJapanese=loadedData._isJapanese,this._fontOrImage=loadedData._fontOrImage,this._suit=loadedData._suit,this._tileSize=loadedData._tileSize,this._isSorted=loadedData._isSorted,!0)},ViewSettings.prototype.save=function(){return Helper.save(ViewSettings.dataKey,this)},ViewSettings.dataKey="ShosChiniisouViewSettings",ViewSettings}(),View=function(){function View(){this.settings_=new ViewSettings,this.settings.load()}return Object.defineProperty(View.prototype,"settings",{get:function(){return this.settings_},enumerable:!0,configurable:!0}),View.prototype.appendHandTo=function(element,hand){var div=this.settings.isSorted?this.handToTileHtml(hand):this.handIndexesToHtml(Model.shuffledHandIndexes(hand));element.append(div)},View.prototype.appendHandIndexesTo=function(element,handIndexes){var div=this.handIndexesToHtml(handIndexes);element.append(div)},Object.defineProperty(View.prototype,"tileStyle",{get:function(){switch(this.settings.tileSize){case TileSize.Small:return"small-tile";case TileSize.Medium:return"medium-tile";case TileSize.Large:return"large-tile"}},enumerable:!0,configurable:!0}),Object.defineProperty(View.prototype,"tileTexts",{get:function(){switch(this.settings.suit){case Suit.Bomboos:return View.bambooTileTexts;case Suit.Dots:return View.dotsTileTexts;default:return View.charactersTileTexts}},enumerable:!0,configurable:!0}),View.prototype.handIndexesToHtml=function(handIndexes){var _this=this,div=$("<div>");return div.addClass(this.tileStyle),handIndexes.forEach((function(handIndex){return div.append(_this.handIndexToHtml(handIndex))})),div},View.prototype.handToTileHtml=function(hand){var _this=this,div=$("<div>");return div.addClass(this.tileStyle),hand.forEach((function(tileNumber,handIndex,self){for(var count=0;count<tileNumber;count++)div.append(_this.handIndexToHtml(handIndex))})),div},View.prototype.handIndexToHtml=function(handIndex){return this.settings.fontOrImage?this.toFontHtml(handIndex):this.toImageHtml(handIndex)},View.prototype.toFontHtml=function(handIndex){return $("<span>").html(this.tileTexts[handIndex])},View.prototype.toImageHtml=function(handIndex){var rate=1;switch(this.settings.tileSize){case TileSize.Small:rate=.75;break;case TileSize.Medium:rate=1;break;case TileSize.Large:rate=1.5}var width=47,height=63;return $("<img >").attr("src",this.getFontImageFileName(handIndex)).attr("width",Math.floor(47*rate)).attr("height",Math.floor(63*rate))},View.prototype.getFontImageFileName=function(handIndex){var fileName="images/p_";switch(this.settings.suit){case Suit.Characters:fileName+="m";break;case Suit.Dots:fileName+="p";break;case Suit.Bomboos:fileName+="s"}return fileName+"s"+String(handIndex+1)+"_1.gif"},View.charactersTileTexts=["&#x1f007;","&#x1f008;","&#x1f009;","&#x1f00a;","&#x1f00b;","&#x1f00c;","&#x1f00d;","&#x1f00e;","&#x1f00f;"],View.bambooTileTexts=["&#x1f010;","&#x1f011;","&#x1f012;","&#x1f013;","&#x1f014;","&#x1f015;","&#x1f016;","&#x1f017;","&#x1f018;"],View.dotsTileTexts=["&#x1f019;","&#x1f01a;","&#x1f01b;","&#x1f01c;","&#x1f01d;","&#x1f01e;","&#x1f01f;","&#x1f020;","&#x1f021;"],View}(),Application=function(){function Application(){this.model=new Model,this.view=new View,this.isQuestion=!0,this.readyToWinHand=[],this.questionNumber=0,this.winsNumber=0,this.initializeControls(),this.setHandlers(),this.setQuestion(),this.view.settings.isJapanese?$('input:radio[name="language"]').val(["japanese"]):$('input:radio[name="language"]').val(["english"]),this.updateLanguage()}return Object.defineProperty(Application.prototype,"qustionText",{get:function(){return this.view.settings.isJapanese?"聴牌":"Ready to win hand"},enumerable:!0,configurable:!0}),Object.defineProperty(Application.prototype,"answerText",{get:function(){return this.view.settings.isJapanese?"待ち":"Winning tiles"},enumerable:!0,configurable:!0}),Application.prototype.initializeControls=function(){$('input:radio[name="language"]').val([this.view.settings.isJapanese?"japanese":"english"]),$('input:radio[name="fontOrImage"]').val([this.view.settings.fontOrImage?"font":"image"]);var suitValue="";switch(this.view.settings.suit){case Suit.Characters:suitValue="characters";break;case Suit.Dots:suitValue="dots";break;case Suit.Bomboos:suitValue="bomboos"}$('input:radio[name="usingTile"]').val([suitValue]);var tileSizeValue="";switch(this.view.settings.tileSize){case TileSize.Small:tileSizeValue="small";break;case TileSize.Medium:tileSizeValue="medium";break;case TileSize.Large:tileSizeValue="large"}$('input:radio[name="tileSize"]').val([tileSizeValue]),$('input:radio[name="sorting"]').val([this.view.settings.isSorted?"sorted":"unsorted"])},Application.prototype.setHandlers=function(){var _this=this;$('input:radio[name="language"]').change((function(){var value;switch($('input:radio[name="language"]:checked').val()){case"japanese":_this.view.settings.isJapanese=!0;break;case"english":_this.view.settings.isJapanese=!1}_this.updateLanguage()})),$('input:radio[name="fontOrImage"]').change((function(){var value;switch($('input:radio[name="fontOrImage"]:checked').val()){case"font":_this.view.settings.fontOrImage=!0;break;case"image":_this.view.settings.fontOrImage=!1}})),$('input:radio[name="usingTile"]').change((function(){var value;switch($('input:radio[name="usingTile"]:checked').val()){case"characters":_this.view.settings.suit=Suit.Characters;break;case"dots":_this.view.settings.suit=Suit.Dots;break;case"bomboos":_this.view.settings.suit=Suit.Bomboos}})),$('input:radio[name="tileSize"]').change((function(){var value;switch($('input:radio[name="tileSize"]:checked').val()){case"small":_this.view.settings.tileSize=TileSize.Small;break;case"medium":_this.view.settings.tileSize=TileSize.Medium;break;case"large":_this.view.settings.tileSize=TileSize.Large}})),$('input:radio[name="sorting"]').change((function(){var value;switch($('input:radio[name="sorting"]:checked').val()){case"sorted":_this.view.settings.isSorted=!0;break;case"unsorted":_this.view.settings.isSorted=!1}})),$("#nextButton").on("click",(function(){_this.isQuestion?_this.setQuestion():_this.setAnswer(),_this.updateQandA()})),$("#answerChecksClear").on("click",(function(){_this.clearAnswerChecks()}))},Application.prototype.setQuestion=function(){this.readyToWinHand=this.model.getNewReadyToWinHand(),$("#hands").html(""),$("#hands").append("<div>"+this.qustionText+":</div>"),this.view.appendHandTo($("#hands"),this.readyToWinHand),this.isQuestion=!1},Application.prototype.setAnswer=function(){var handIndexes=Model.makeComplateHandIndexes(this.readyToWinHand);$("#hands").append("<div>"+this.answerText+":</div>"),this.view.appendHandIndexesTo($("#hands"),handIndexes),this.isQuestion=!0,this.judge(handIndexes)},Application.prototype.judge=function(correctHandIndexes){var usersAnswerHandIndexes=this.getHandIndexes();Helper.arrayEquals(usersAnswerHandIndexes,correctHandIndexes)&&this.winsNumber++,this.questionNumber++,this.updateNumbers()},Application.prototype.clearAnswerChecks=function(){$('input[name="answerCheck"]').prop("checked",!1)},Application.prototype.updateQandA=function(){this.updateNextButton(),this.updateAnswerChecks(),this.updateNumbers()},Application.prototype.updateNextButton=function(){this.view.settings.isJapanese?$("#nextButton").val(this.isQuestion?"次の問題":"待ちを表示"):$("#nextButton").val(this.isQuestion?"Next":"Show winning tiles")},Application.prototype.updateAnswerChecks=function(){this.isQuestion?($('input[name="answerCheck"]').prop("disabled",!0),$("#answerChecksClear").prop("disabled",!0)):(this.clearAnswerChecks(),$('input[name="answerCheck"]').prop("disabled",!1),$("#answerChecksClear").prop("disabled",!1))},Application.prototype.getHandIndexes=function(){for(var handIndexes=[],handIndex=0;handIndex<9;handIndex++)$("#answerCheck"+String(handIndex+1)).prop("checked")&&handIndexes.push(handIndex);return handIndexes},Application.prototype.updateNumbers=function(){$("#winsNumber").text(String(this.winsNumber)),$("#questionNumber").text(String(this.questionNumber))},Application.prototype.updateLanguage=function(){this.view.settings.isJapanese?($("#title").html("麻雀 清一色の練習 | 翔ソフトウェア (Sho's)"),$("#usingTileLabel").html("牌"),$('label[for="usingTileCharacters"]').text("萬子"),$('label[for="usingTileDots"]').text("筒子"),$('label[for="usingTileBomboos"]').text("索子"),$("#tileSizeLabel").html("牌の大きさ"),$('label[for="tileSizeSmall"]').text("小"),$('label[for="tileSizeMedium"]').text("中"),$('label[for="tileSizeLarge"]').text("大"),$("#languageLabel").html("言語 (Language)"),$('label[for="languageEnglish"]').text("英語 (English)"),$('label[for="languageJapanese"]').text("日本語 (Japanese)"),$("#fontOrImageLabel").html("牌の描画方法 (表示がおかしいときは「画像」を選択)"),$('label[for="fontOrImageFont"]').text("フォント"),$('label[for="fontOrImageImage"]').text("画像"),$("#sortingLabel").html("理牌"),$('label[for="sortingSorted"]').text("あり"),$('label[for="sortingUnsorted"]').text("なし"),$("#answerChecksClear").val("クリア"),$("#winsNumberLabel").html("正解数"),$("#answerPanel").html("何待ち?")):($("#title").html("Mahjong Flush Practice | Sho's Software"),$("#languageLabel").html("Language (言語)"),$('label[for="languageEnglish"]').text("English (英語)"),$('label[for="languageJapanese"]').text("Japanese (日本語)"),$("#fontOrImageLabel").html('How to draw the tiles (If the display is not correct, choose "Images.")'),$('label[for="fontOrImageFont"]').text("Font"),$('label[for="fontOrImageImage"]').text("Images"),$("#usingTileLabel").html("Tiles"),$('label[for="usingTileCharacters"]').text("Characters"),$('label[for="usingTileDots"]').text("Dots"),$('label[for="usingTileBomboos"]').text("Bomboos"),$("#tileSizeLabel").html("Tile size"),$('label[for="tileSizeSmall"]').text("Small"),$('label[for="tileSizeMedium"]').text("Medium"),$('label[for="tileSizeLarge"]').text("Large"),$("#sortingLabel").html("Sorting"),$('label[for="sortingSorted"]').text("Sorted"),$('label[for="sortingUnsorted"]').text("Unsorted"),$("#answerChecksClear").val("Clear"),$("#winsNumberLabel").html("Correct Answers"),$("#answerPanel").html("Winning tiles?")),this.updateQandA()},Application}();Chiniisou.Application=Application}(Chiniisou||(Chiniisou={})),$(document).ready((function(){return new Chiniisou.Application}));